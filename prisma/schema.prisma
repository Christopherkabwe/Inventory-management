// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["driverAdapters"]
  output          = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// ==================== GLOBAL SEQUENCE ====================
model Sequence {
  id        String
  year      Int
  value     Int
  updatedAt DateTime @updatedAt

  @@id([id, year])
}

// ==================== USERS ====================
model User {
  id                   String    @id @default(cuid())
  email                String?   @unique
  fullName             String?
  role                 UserRole  @default(USER)
  password             String // hashed password
  passwordResetToken   String? // token
  passwordResetExpires DateTime? // expiration
  stackAuthId          String?   @unique
  isActive             Boolean   @default(true)
  locationId           String? // nullable for admins
  location             Location? @relation(fields: [locationId], references: [id])
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt

  sessions     Session[]
  createdSales Sale[]     @relation("SalesCreatedBy")
  customers    Customer[] // customers assigned to this User

  createdTransfers     Transfer[]        @relation("TransfersCreatedBy")
  createdAdjustments   Adjustment[]      @relation("AdjustmentsCreatedBy")
  createdProductions   Production[]      @relation("ProductionsCreatedBy")
  createdProducts      ProductList[]     @relation("ProductsCreatedBy")
  createdCustomers     Customer[]        @relation("CustomersCreatedBy")
  createdQuotations    Quotation[]       @relation("QuotationsCreatedBy")
  createdOrders        SalesOrder[]      @relation("OrdersCreatedBy")
  receivedTransfers    TransferReceipt[] @relation("TransfersReceivedBy")
  createdInventory     Inventory[]       @relation("InventoryCreatedBy")
  createdDeliveryNotes DeliveryNote[]    @relation("DeliveryNotesCreatedBy")
  createdCreditNotes   CreditNote[]      @relation("CreditNotesCreatedBy")
  createdSaleReturns   SaleReturn[]      @relation("SaleReturnsCreatedBy")

  // ðŸ”¹ HIERARCHY
  managerId String?
  manager   User?   @relation("UserManager", fields: [managerId], references: [id])
  users     User[]  @relation("UserManager")

  // ðŸ”¹ INVENTORY
  assignedInventory  Inventory[]        @relation("InventoryAssignedUser")
  inventoryHistories InventoryHistory[]

  @@index([managerId])
}

enum UserRole {
  ADMIN
  MANAGER
  USER
}

model Session {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  revoked   Boolean @default(false)
  ipAddress String?
  userAgent String?

  expiresAt DateTime
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([revoked])
  @@index([expiresAt])
}

// ==================== PRODUCTS ====================
model ProductList {
  id          String   @id @default(cuid())
  sku         String   @unique
  name        String
  price       Float
  costPerBag  Float?
  packSize    Int
  category    String?
  weightValue Float
  weightUnit  String
  categoryId  String?      
  category    Category?    @relation(fields: [categoryId], references: [id])
  createdById String
  createdBy   User     @relation("ProductsCreatedBy", fields: [createdById], references: [id])
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  inventories     Inventory[]
  saleItems       SaleItem[]
  transferItems   TransferItem[]
  productionItems ProductionItem[]
  adjustmentItems AdjustmentItem[]
  orderItems      SalesOrderItem[]
  quotationItems  QuotationItem[]
  saleReturns     SaleReturn[]

  deliveryNoteItems    DeliveryNoteItem[]
  transferReceiptItems TransferReceiptItem[]
  inventoryHistories   InventoryHistory[]
}

// ==================== PRODUCT CATEGORIES ====================
model Category {
  id        String       @id @default(cuid())
  name      String       @unique
  products  ProductList[] // one category â†’ many products
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt
}


// ==================== LOCATIONS ====================
model Location {
  id        String     @id @default(cuid())
  name      String     @unique
  address   String?
  users     User[]
  customers Customer[] //one location â†’ many customers
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt

  inventories        Inventory[]
  sales              Sale[]
  orders             SalesOrder[]
  transfersFrom      Transfer[]         @relation("TransfersFrom")
  transfersTo        Transfer[]         @relation("TransfersTo")
  adjustments        Adjustment[]
  productions        Production[]
  deliveryNotes      DeliveryNote[]
  quotations         Quotation[]
  saleReturns        SaleReturn[]
  inventoryHistories InventoryHistory[]
}

// ==================== INVENTORY ====================
model Inventory {
  id          String      @id @default(cuid())
  productId   String
  product     ProductList @relation(fields: [productId], references: [id])
  locationId  String
  location    Location    @relation(fields: [locationId], references: [id])
  quantity    Int
  lowStockAt  Int
  inTransit   Int?        @default(0)
  expiryDate  DateTime?
  createdById String

  assignedUserId String?
  assignedUser   User?   @relation("InventoryAssignedUser", fields: [assignedUserId], references: [id])

  createdBy User     @relation("InventoryCreatedBy", fields: [createdById], references: [id])
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([productId, locationId])
}

enum InventorySource {
  SYSTEM // initial stock import
  SALE // sale item reduces stock
  TRANSFER_IN // stock received via transfer
  TRANSFER_IN_TRANSIT // stock received via transfer
  TRANSFER_OUT // stock sent via transfer
  TRANSFER_DAMAGED
  TRANSFER_EXPIRED
  PRODUCTION // production adds stock
  ADJUSTMENT // manual adjustment
  RETURN // sale return adds stock
  INITIAL
}

model InventoryHistory {
  id         String          @id @default(cuid())
  productId  String
  product    ProductList     @relation(fields: [productId], references: [id])
  locationId String
  location   Location        @relation(fields: [locationId], references: [id])
  date       DateTime // time of the transaction
  delta      Int // positive for stock in, negative for stock out
  inTransitDelta Int?
  sourceType InventorySource
  reference  String // e.g., SALE-INV123, TRANSFER-IBT001

  // Optional links for auditing
  createdById String? // optional
  createdBy   User?   @relation(fields: [createdById], references: [id])
  metadata    Json? // optional extra info

  saleItemId            String?              @unique
  saleItem              SaleItem?            @relation(fields: [saleItemId], references: [id])
  transferReceiptItemId String?              @unique
  transferReceiptItem   TransferReceiptItem? @relation(fields: [transferReceiptItemId], references: [id])
  productionItemId      String?              @unique
  productionItem        ProductionItem?      @relation(fields: [productionItemId], references: [id])
  adjustmentItemId      String?              @unique
  adjustmentItem        AdjustmentItem?      @relation(fields: [adjustmentItemId], references: [id])
  saleReturnId          String?              @unique
  saleReturn            SaleReturn?          @relation(fields: [saleReturnId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt
}

// ==================== CUSTOMERS ====================
model Customer {
  id          String   @id @default(cuid())
  name        String
  tpinNumber  String?
  email       String?   @unique
  phone       String?
  country     String
  city        String
  address     String?
  createdById String
  userId      String?
  assignedUser String?
  user        User?    @relation(fields: [userId], references: [id])
  createdBy   User     @relation("CustomersCreatedBy", fields: [createdById], references: [id])
  locationId  String
  location    Location @relation(fields: [locationId], references: [id])
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  sales      Sale[]
  orders     SalesOrder[]
  quotations Quotation[]
}

// ==================== TRANSPORTERS ====================
model Transporter {
  id                String   @id @default(cuid())
  name              String
  vehicleNumber     String?
  driverName        String?
  driverPhoneNumber String?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @default(now())

  sales         Sale[]
  transfers     Transfer[]
  deliveryNotes DeliveryNote[]
}

// ==================== SALES ORDERS ====================
model SalesOrder {
  id          String           @id @default(cuid())
  orderNumber String           @unique
  customerId  String
  customer    Customer         @relation(fields: [customerId], references: [id])
  locationId  String
  location    Location         @relation(fields: [locationId], references: [id])
  status      SalesOrderStatus @default(PENDING)
  createdById String
  createdBy   User             @relation("OrdersCreatedBy", fields: [createdById], references: [id])
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @default(now())

  items         SalesOrderItem[]
  invoices      Sale[]
  deliveryNotes DeliveryNote[]
}

model SalesOrderItem {
  id               String      @id @default(cuid())
  salesOrderId     String
  salesOrder       SalesOrder  @relation(fields: [salesOrderId], references: [id], onDelete: Cascade)
  productId        String
  product          ProductList @relation(fields: [productId], references: [id])
  quantity         Int
  quantityInvoiced Int         @default(0)
  updatedAt        DateTime    @default(now()) @updatedAt
}

// ==================== SALES (INVOICES) ====================
model Sale {
  id             String       @id @default(cuid())
  invoiceNumber  String       @unique
  deliveryNoteNo String?
  salesOrderId   String
  salesOrder     SalesOrder   @relation(fields: [salesOrderId], references: [id])
  locationId     String
  location       Location     @relation(fields: [locationId], references: [id])
  customerId     String
  customer       Customer     @relation(fields: [customerId], references: [id])
  transporterId  String?
  transporter    Transporter? @relation(fields: [transporterId], references: [id])
  driverName     String?
  saleDate       DateTime     @default(now())
  createdById    String
  createdBy      User         @relation("SalesCreatedBy", fields: [createdById], references: [id])
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @default(now())
  status         SaleStatus   @default(PENDING)

  items         SaleItem[]
  creditNotes   CreditNote[]
  returns       SaleReturn[]
  deliveryNotes DeliveryNote[]
}

model SaleItem {
  id                 String             @id @default(cuid())
  saleId             String
  sale               Sale               @relation(fields: [saleId], references: [id], onDelete: Cascade)
  productId          String
  product            ProductList        @relation(fields: [productId], references: [id])
  quantity           Int
  quantityInvoiced   Int                @default(0)
  quantityDelivered  Int                @default(0)
  quantityReturned   Int                @default(0)
  price              Float
  total              Float
  updatedAt          DateTime           @default(now()) @updatedAt
  inventoryHistories InventoryHistory[]

  @@index([saleId])
  @@index([productId])
}

// ==================== DELIVERY NOTES ====================
model DeliveryNote {
  id             String       @id @default(cuid())
  deliveryNoteNo String       @unique
  saleId         String
  sale           Sale         @relation(fields: [saleId], references: [id])
  salesOrderId   String
  salesOrder     SalesOrder   @relation(fields: [salesOrderId], references: [id])
  locationId     String
  location       Location     @relation(fields: [locationId], references: [id])
  transporterId  String?
  transporter    Transporter? @relation(fields: [transporterId], references: [id])
  dispatchedAt   DateTime     @default(now())
  createdById    String
  createdBy      User         @relation("DeliveryNotesCreatedBy", fields: [createdById], references: [id])

  items DeliveryNoteItem[]
}

model DeliveryNoteItem {
  id                String       @id @default(cuid())
  deliveryNoteId    String
  deliveryNote      DeliveryNote @relation(fields: [deliveryNoteId], references: [id], onDelete: Cascade)
  productId         String
  product           ProductList  @relation(fields: [productId], references: [id])
  quantityDelivered Int

  updatedAt DateTime @default(now()) @updatedAt

  @@index([deliveryNoteId])
  @@index([productId])
}

// ==================== QUOTATIONS ====================
model Quotation {
  id          String          @id @default(cuid())
  quoteNumber String          @unique
  customerId  String
  customer    Customer        @relation(fields: [customerId], references: [id])
  locationId  String
  location    Location        @relation(fields: [locationId], references: [id])
  status      QuotationStatus @default(PENDING)
  createdById String
  createdBy   User            @relation("QuotationsCreatedBy", fields: [createdById], references: [id])
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @default(now())

  items QuotationItem[]
}

model QuotationItem {
  id          String      @id @default(cuid())
  quotationId String
  quotation   Quotation   @relation(fields: [quotationId], references: [id], onDelete: Cascade)
  productId   String
  product     ProductList @relation(fields: [productId], references: [id])
  quantity    Int
  price       Float
  total       Float
  updatedAt   DateTime    @default(now()) @updatedAt
}

enum QuotationStatus {
  PENDING
  APPROVED
  REJECTED
}

// ==================== CREDIT NOTES ====================
model CreditNote {
  id               String   @id @default(cuid())
  creditNoteNumber String   @unique
  saleId           String
  sale             Sale     @relation(fields: [saleId], references: [id], onDelete: Cascade)
  reason           String
  amount           Float
  createdById      String
  createdBy        User     @relation("CreditNotesCreatedBy", fields: [createdById], references: [id])
  createdAt        DateTime @default(now())
  updatedAt        DateTime @default(now())
}

// ==================== SALE RETURNS ====================
model SaleReturn {
  id               String            @id @default(cuid())
  returnNumber     String            @unique
  saleId           String
  sale             Sale              @relation(fields: [saleId], references: [id], onDelete: Cascade)
  productId        String
  product          ProductList       @relation(fields: [productId], references: [id])
  quantity         Int
  reason           String
  createdById      String
  createdBy        User              @relation("SaleReturnsCreatedBy", fields: [createdById], references: [id])
  locationId       String
  location         Location          @relation(fields: [locationId], references: [id])
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @default(now())
  inventoryHistory InventoryHistory?
}

// ==================== TRANSFERS (IBT) ====================
model Transfer {
  id             String           @id @default(cuid())
  ibtNumber      String           @unique
  fromLocationId String
  fromLocation   Location         @relation("TransfersFrom", fields: [fromLocationId], references: [id])
  toLocationId   String
  toLocation     Location         @relation("TransfersTo", fields: [toLocationId], references: [id])
  transporterId  String?
  transporter    Transporter?     @relation(fields: [transporterId], references: [id])
  transferDate   DateTime         @default(now())
  createdById    String
  createdBy      User             @relation("TransfersCreatedBy", fields: [createdById], references: [id])
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @default(now())
  status         TransferStatus   @default(PENDING)
  items          TransferItem[]
  receipt        TransferReceipt?
}

model TransferItem {
  id         String      @id @default(cuid())
  transferId String
  transfer   Transfer    @relation(fields: [transferId], references: [id], onDelete: Cascade)
  productId  String
  product    ProductList @relation(fields: [productId], references: [id])
  quantity   Int
  updatedAt  DateTime    @default(now()) @updatedAt
}

model TransferReceipt {
  id           String                @id @default(cuid())
  transferId   String                @unique
  transfer     Transfer              @relation(fields: [transferId], references: [id], onDelete: Cascade)
  receivedById String
  receivedBy   User                  @relation("TransfersReceivedBy", fields: [receivedById], references: [id])
  receivedAt   DateTime              @default(now())
  items        TransferReceiptItem[]
}

model TransferReceiptItem {
  id                 String             @id @default(cuid())
  transferReceiptId  String
  transferReceipt    TransferReceipt    @relation(fields: [transferReceiptId], references: [id], onDelete: Cascade)
  productId          String
  product            ProductList        @relation(fields: [productId], references: [id])
  quantityReceived   Int
  quantityDamaged    Int
  quantityExpired    Int
  comment            String?
  updatedAt          DateTime           @default(now()) @updatedAt
  inventoryHistories InventoryHistory[]
}

// ==================== ENUMS ====================
enum TransferStatus {
  PENDING
  DISPATCHED
  RECEIVED
  CANCELLED
}

// ==================== PRODUCTION ====================
model Production {
  id           String           @id @default(cuid())
  productionNo String           @unique
  locationId   String
  location     Location         @relation(fields: [locationId], references: [id])
  batchNumber  String
  notes        String?
  createdById  String
  createdBy    User             @relation("ProductionsCreatedBy", fields: [createdById], references: [id])
  createdAt    DateTime         @default(now())
  updatedAt    DateTime         @default(now())
  items        ProductionItem[]

  @@index([createdAt])
  @@index([locationId])
  @@index([batchNumber])
}

model ProductionItem {
  id                 String             @id @default(cuid())
  productionId       String
  production         Production         @relation(fields: [productionId], references: [id], onDelete: Cascade)
  productId          String
  product            ProductList        @relation(fields: [productId], references: [id])
  quantity           Int
  updatedAt          DateTime           @default(now()) @updatedAt
  inventoryHistories InventoryHistory[]
}

// ==================== ADJUSTMENTS ====================
model Adjustment {
  id           String           @id @default(cuid())
  adjustmentNo String           @unique
  locationId   String
  location     Location         @relation(fields: [locationId], references: [id])
  type         AdjustmentType
  reason       String?
  createdById  String
  createdBy    User             @relation("AdjustmentsCreatedBy", fields: [createdById], references: [id])
  createdAt    DateTime         @default(now())
  updatedAt    DateTime         @default(now())
  items        AdjustmentItem[]
}

model AdjustmentItem {
  id                 String             @id @default(cuid())
  adjustmentId       String
  adjustment         Adjustment         @relation(fields: [adjustmentId], references: [id], onDelete: Cascade)
  productId          String
  product            ProductList        @relation(fields: [productId], references: [id])
  quantity           Int
  updatedAt          DateTime           @default(now()) @updatedAt
  inventoryHistories InventoryHistory[]
}

enum AdjustmentType {
  DAMAGED
  EXPIRED
  MANUAL
}

// ==================== ENUMS ====================
enum SalesOrderStatus {
  PENDING
  CONFIRMED
  PARTIALLY_INVOICED
  CANCELLED
}

enum SaleStatus {
  PENDING
  CONFIRMED
  PARTIALLY_INVOICED
  CANCELLED
}

enum ProductionStatus {
  DRAFT
  CONFIRMED
  LOCKED
}
