// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["driverAdapters"]
  output          = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// ==================== GLOBAL SEQUENCE ====================
model Sequence {
  id          String
  year        Int
  value       Int
  locked      Boolean   @default(false)
  lastResetAt DateTime?
  updatedAt   DateTime  @updatedAt
  updatedById String?

  updatedBy User? @relation(fields: [updatedById], references: [id])

  audits SequenceAudit[]

  @@id([id, year])
}

model SequenceAudit {
  id            String         @id @default(cuid())
  sequenceId    String
  year          Int
  oldValue      Int
  newValue      Int
  action        SequenceAction
  performedById String
  performedBy   User           @relation(fields: [performedById], references: [id])
  performedAt   DateTime       @default(now())
  reason        String?
  sequence      Sequence?      @relation(fields: [sequenceId, sequenceYear], references: [id, year])
  sequenceYear  Int?

  @@index([sequenceId, year])
}

enum SequenceAction {
  RESET
  LOCK
  UNLOCK
}

// ==================== USERS ====================
model User {
  id                   String    @id @default(cuid())
  email                String?   @unique
  fullName             String?
  role                 UserRole  @default(USER)
  password             String // hashed password
  passwordResetToken   String? // token
  passwordResetExpires DateTime? // expiration
  stackAuthId          String?   @unique
  isActive             Boolean   @default(true)
  locationId           String? // nullable for admins
  location             Location? @relation(fields: [locationId], references: [id])
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt

  sessions     Session[]
  createdSales Sale[]     @relation("SalesCreatedBy")
  customers    Customer[] // customers assigned to this User

  createdTransfers     Transfer[]        @relation("TransfersCreatedBy")
  createdAdjustments   Adjustment[]      @relation("AdjustmentsCreatedBy")
  createdProductions   Production[]      @relation("ProductionsCreatedBy")
  createdProducts      ProductList[]     @relation("ProductsCreatedBy")
  createdCustomers     Customer[]        @relation("CustomersCreatedBy")
  createdQuotations    Quotation[]       @relation("QuotationsCreatedBy")
  createdOrders        SalesOrder[]      @relation("OrdersCreatedBy")
  receivedTransfers    TransferReceipt[] @relation("TransfersReceivedBy")
  createdInventory     Inventory[]       @relation("InventoryCreatedBy")
  createdDeliveryNotes DeliveryNote[]    @relation("DeliveryNotesCreatedBy")
  createdCreditNotes   CreditNote[]      @relation("CreditNotesCreatedBy")
  createdSaleReturns   SaleReturn[]      @relation("SaleReturnsCreatedBy")

  // ðŸ”¹ HIERARCHY
  managerId String?
  manager   User?   @relation("UserManager", fields: [managerId], references: [id])
  users     User[]  @relation("UserManager")

  // ðŸ”¹ INVENTORY
  assignedInventory  Inventory[]         @relation("InventoryAssignedUser")
  inventoryHistories InventoryHistory[]
  customerPayments   CustomerPayment[]
  paymentAllocations PaymentAllocation[]
  allocationAudits   AllocationAudit[]
  customerStatements CustomerStatement[]
  productionDefects  ProductionDefect[]
  boms               BOM[]
  purchaseOrders     PurchaseOrder[]
  sequences          Sequence[]
  sequenceAudits     SequenceAudit[]

  @@index([managerId])
}

enum UserRole {
  ADMIN
  MANAGER
  USER
}

model Session {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  revoked   Boolean @default(false)
  ipAddress String?
  userAgent String?

  expiresAt DateTime
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([revoked])
  @@index([expiresAt])
}

// ==================== PRODUCTS ====================
enum ProductType {
  RAW_MATERIAL
  PACKAGING
  SEMI_FINISHED
  FINISHED
}

model ProductList {
  id          String      @id @default(cuid())
  sku         String      @unique
  name        String
  price       Float
  costPerBag  Float?
  packSize    Int
  category    String?
  subCategory String?
  weightValue Float
  weightUnit  String
  createdById String
  isTaxable   String?
  taxRate     Float?
  createdBy   User        @relation("ProductsCreatedBy", fields: [createdById], references: [id])
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  type        ProductType @default(FINISHED)

  inventories     Inventory[]
  saleItems       SaleItem[]
  transferItems   TransferItem[]
  productionItems ProductionItem[]
  adjustmentItems AdjustmentItem[]
  orderItems      SalesOrderItem[]
  quotationItems  QuotationItem[]
  saleReturns     SaleReturn[]

  deliveryNoteItems    DeliveryNoteItem[]
  transferReceiptItems TransferReceiptItem[]
  inventoryHistories   InventoryHistory[]
  proformaInvoiceItems ProformaInvoiceItem[]
  saleReturnItems      SaleReturnItem[]
  productionDefects    ProductionDefect[]
  boms                 BOM[]
  bomitems             BOMItem[]
  supplierPrices       SupplierPrice[]
  purchaseOrderItems   PurchaseOrderItem[]
}

// ==================== LOCATIONS ====================
model Location {
  id        String     @id @default(cuid())
  name      String     @unique
  address   String?
  users     User[]
  customers Customer[] //one location â†’ many customers
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt

  inventories        Inventory[]
  sales              Sale[]
  orders             SalesOrder[]
  transfersFrom      Transfer[]         @relation("TransfersFrom")
  transfersTo        Transfer[]         @relation("TransfersTo")
  adjustments        Adjustment[]
  productions        Production[]
  deliveryNotes      DeliveryNote[]
  quotations         Quotation[]
  saleReturns        SaleReturn[]
  inventoryHistories InventoryHistory[]
  proformaInvoices   ProformaInvoice[]
  purchaseOrders     PurchaseOrder[]
  grns               GRN[]
}

// ==================== INVENTORY ====================
model Inventory {
  id          String      @id @default(cuid())
  productId   String
  product     ProductList @relation(fields: [productId], references: [id])
  locationId  String
  location    Location    @relation(fields: [locationId], references: [id])
  quantity    Int
  lowStockAt  Int
  inTransit   Int?        @default(0)
  expiryDate  DateTime?
  createdById String

  assignedUserId String?
  assignedUser   User?   @relation("InventoryAssignedUser", fields: [assignedUserId], references: [id])

  createdBy User     @relation("InventoryCreatedBy", fields: [createdById], references: [id])
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([productId, locationId])
}

enum InventorySource {
  SYSTEM // initial stock import
  SALE // sale item reduces stock
  TRANSFER_IN // stock received via transfer
  TRANSFER_IN_TRANSIT // stock received via transfer
  TRANSFER_OUT // stock sent via transfer
  TRANSFER_DAMAGED
  TRANSFER_EXPIRED
  PRODUCTION // production adds stock
  PRODUCTION_DEFECT
  REVERSED_PRODUCTION_DEFECT
  ADJUSTMENT // manual adjustment
  RETURN // sale return adds stock
  INITIAL
  PURCHASE_RECEIPT
  PURCHASE_RETURN
}

model InventoryHistory {
  id                 String            @id @default(cuid())
  productId          String
  product            ProductList       @relation(fields: [productId], references: [id])
  locationId         String
  location           Location          @relation(fields: [locationId], references: [id])
  date               DateTime // time of the transaction
  delta              Int // positive for stock in, negative for stock out
  inTransitDelta     Int?
  sourceType         InventorySource
  reference          String // e.g., SALE-INV123, TRANSFER-IBT001
  productionDefectId String?
  productionDefect   ProductionDefect? @relation(fields: [productionDefectId], references: [id])

  // Optional links for auditing
  createdById String? // optional
  createdBy   User?   @relation(fields: [createdById], references: [id])
  metadata    Json? // optional extra info

  saleItemId            String?              @unique
  saleItem              SaleItem?            @relation(fields: [saleItemId], references: [id])
  transferReceiptItemId String?              @unique
  transferReceiptItem   TransferReceiptItem? @relation(fields: [transferReceiptItemId], references: [id])
  productionItemId      String?              @unique
  productionItem        ProductionItem?      @relation(fields: [productionItemId], references: [id])
  adjustmentItemId      String?              @unique
  adjustmentItem        AdjustmentItem?      @relation(fields: [adjustmentItemId], references: [id])
  saleReturnId          String?              @unique
  saleReturn            SaleReturn?          @relation(fields: [saleReturnId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt
  grnitem   GRNItem? @relation(fields: [gRNItemId], references: [id])
  gRNItemId String?
}

// ==================== CUSTOMERS ====================
model Customer {
  id           String   @id @default(cuid())
  name         String
  tpinNumber   String?
  email        String?  @unique
  phone        String?
  country      String
  city         String
  address      String?
  createdById  String
  userId       String?
  assignedUser String?
  user         User?    @relation(fields: [userId], references: [id])
  createdBy    User     @relation("CustomersCreatedBy", fields: [createdById], references: [id])
  locationId   String
  location     Location @relation(fields: [locationId], references: [id])
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  sales            Sale[]
  orders           SalesOrder[]
  payments         CustomerPayment[]
  quotations       Quotation[]
  proformaInvoices ProformaInvoice[]
}

// ==================== TRANSPORTERS ====================
model Transporter {
  id                String   @id @default(cuid())
  name              String
  vehicleNumber     String?
  driverName        String?
  driverPhoneNumber String?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @default(now())

  sales         Sale[]
  transfers     Transfer[]
  deliveryNotes DeliveryNote[]
}

// ==================== SALES ORDERS ====================
model SalesOrder {
  id          String           @id @default(cuid())
  orderNumber String           @unique
  customerId  String
  customer    Customer         @relation(fields: [customerId], references: [id])
  locationId  String
  location    Location         @relation(fields: [locationId], references: [id])
  status      SalesOrderStatus @default(PENDING)
  createdById String
  createdBy   User             @relation("OrdersCreatedBy", fields: [createdById], references: [id])
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @default(now())

  items            SalesOrderItem[]
  invoices         Sale[]
  deliveryNotes    DeliveryNote[]
  proformaInvoices ProformaInvoice[]
}

model SalesOrderItem {
  id               String      @id @default(cuid())
  salesOrderId     String
  salesOrder       SalesOrder  @relation(fields: [salesOrderId], references: [id], onDelete: Cascade)
  productId        String
  product          ProductList @relation(fields: [productId], references: [id])
  quantity         Int
  quantityInvoiced Int         @default(0)
  updatedAt        DateTime    @default(now()) @updatedAt
}

// ==================== SALES (INVOICES) ====================
model Sale {
  id             String              @id @default(cuid())
  invoiceNumber  String              @unique
  deliveryNoteNo String?
  salesOrderId   String
  salesOrder     SalesOrder          @relation(fields: [salesOrderId], references: [id])
  locationId     String
  location       Location            @relation(fields: [locationId], references: [id])
  customerId     String
  customer       Customer            @relation(fields: [customerId], references: [id])
  transporterId  String?
  transporter    Transporter?        @relation(fields: [transporterId], references: [id])
  driverName     String?
  saleDate       DateTime            @default(now())
  dueDate        DateTime?
  createdById    String
  createdBy      User                @relation("SalesCreatedBy", fields: [createdById], references: [id])
  createdAt      DateTime            @default(now())
  updatedAt      DateTime            @default(now())
  status         SaleStatus          @default(PENDING)
  payments       SalePayment[]
  allocations    PaymentAllocation[]
  paymentStatus  PaymentStatus       @default(PENDING)

  items                 SaleItem[]
  creditNotes           CreditNote[]
  returns               SaleReturn[]
  deliveryNotes         DeliveryNote[]
  allocationAudits      AllocationAudit[]
  creditNoteAllocations CreditNoteAllocation[]
}

model SaleItem {
  id                 String             @id @default(cuid())
  saleId             String
  sale               Sale               @relation(fields: [saleId], references: [id], onDelete: Cascade)
  productId          String
  product            ProductList        @relation(fields: [productId], references: [id])
  quantity           Int
  quantityInvoiced   Int                @default(0)
  quantityDelivered  Int                @default(0)
  quantityReturned   Int                @default(0)
  price              Float
  total              Float
  updatedAt          DateTime           @default(now()) @updatedAt
  inventoryHistories InventoryHistory[]

  @@index([saleId])
  @@index([productId])
}

model SalePayment {
  id        String   @id @default(cuid())
  saleId    String
  sale      Sale     @relation(fields: [saleId], references: [id], onDelete: Cascade)
  amount    Float
  method    String
  reference String?
  createdAt DateTime @default(now())
}

model CustomerPayment {
  id String @id @default(cuid())

  customerId String
  customer   Customer @relation(fields: [customerId], references: [id])

  amount          Float
  method          String
  reference       String?
  allocatedAmount Float?
  balance         Float?
  paymentDate     DateTime @default(now())

  createdById String
  createdBy   User   @relation(fields: [createdById], references: [id])

  allocations PaymentAllocation[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([customerId])
  @@index([paymentDate])
}

model PaymentAllocation {
  id String @id @default(cuid())

  customerPaymentId String
  customerPayment   CustomerPayment @relation(fields: [customerPaymentId], references: [id], onDelete: Cascade)

  saleId  String
  sale    Sale                @relation(fields: [saleId], references: [id], onDelete: Cascade)
  history AllocationHistory[]

  amount      Float
  createdById String?
  createdBy   User?    @relation(fields: [createdById], references: [id])
  createdAt   DateTime @default(now())

  @@unique([customerPaymentId, saleId])
  @@index([saleId])
  @@index([customerPaymentId])
}

model CreditNoteAllocation {
  id           String     @id @default(cuid())
  creditNoteId String
  creditNote   CreditNote @relation(fields: [creditNoteId], references: [id])
  saleId       String
  sale         Sale       @relation(fields: [saleId], references: [id])
  amount       Float
  createdAt    DateTime   @default(now())

  @@unique([creditNoteId, saleId])
  @@index([saleId])
  @@index([creditNoteId])
}

model AllocationHistory {
  id                String           @id @default(cuid())
  allocationId      String
  saleId            String
  customerPaymentId String
  amount            Decimal
  action            AllocationAction
  createdAt         DateTime         @default(now())
  createdById       String?
  notes             String?

  allocation PaymentAllocation @relation(fields: [allocationId], references: [id])
}

enum AllocationAction {
  CREATE
  UPDATE
  DELETE
  ROLLBACK
}

model AllocationAudit {
  id                String           @id @default(cuid())
  customerPaymentId String
  saleId            String?
  sale              Sale?            @relation(fields: [saleId], references: [id])
  oldAmount         Decimal
  newAmount         Decimal
  action            AllocationAction
  createdAt         DateTime         @default(now())
  createdById       String?
  createdBy         User?            @relation(fields: [createdById], references: [id])
  reason            String?

  @@index([customerPaymentId])
  @@index([saleId])
  @@index([createdById])
}

enum PaymentStatus {
  PENDING // nothing paid yet
  PARTIAL // partially paid
  PAID // fully paid
}

// ==================== DELIVERY NOTES ====================
model DeliveryNote {
  id             String       @id @default(cuid())
  deliveryNoteNo String       @unique
  saleId         String       @unique
  sale           Sale         @relation(fields: [saleId], references: [id])
  salesOrderId   String
  salesOrder     SalesOrder   @relation(fields: [salesOrderId], references: [id])
  locationId     String
  location       Location     @relation(fields: [locationId], references: [id])
  transporterId  String?
  transporter    Transporter? @relation(fields: [transporterId], references: [id])
  dispatchedAt   DateTime     @default(now())
  createdAt      DateTime     @default(now())
  createdById    String
  createdBy      User         @relation("DeliveryNotesCreatedBy", fields: [createdById], references: [id])

  items DeliveryNoteItem[]

  @@index([saleId])
  @@index([salesOrderId])
}

model DeliveryNoteItem {
  id                String       @id @default(cuid())
  deliveryNoteId    String
  deliveryNote      DeliveryNote @relation(fields: [deliveryNoteId], references: [id], onDelete: Cascade)
  productId         String
  product           ProductList  @relation(fields: [productId], references: [id])
  quantityDelivered Int

  updatedAt DateTime @default(now()) @updatedAt

  @@index([deliveryNoteId])
  @@index([productId])
}

// ==================== QUOTATIONS ====================
model Quotation {
  id          String          @id @default(cuid())
  quoteNumber String          @unique
  customerId  String
  customer    Customer        @relation(fields: [customerId], references: [id])
  locationId  String
  location    Location        @relation(fields: [locationId], references: [id])
  status      QuotationStatus @default(PENDING)
  createdById String
  createdBy   User            @relation("QuotationsCreatedBy", fields: [createdById], references: [id])
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @default(now())

  items QuotationItem[]
}

model QuotationItem {
  id          String      @id @default(cuid())
  quotationId String
  quotation   Quotation   @relation(fields: [quotationId], references: [id], onDelete: Cascade)
  productId   String
  product     ProductList @relation(fields: [productId], references: [id])
  quantity    Int
  price       Float
  total       Float
  updatedAt   DateTime    @default(now()) @updatedAt
}

enum QuotationStatus {
  PENDING
  APPROVED
  REJECTED
}

// ==================== CREDIT NOTES ====================
model CreditNote {
  id               String @id @default(cuid())
  creditNoteNumber String @unique
  saleId           String
  sale             Sale   @relation(fields: [saleId], references: [id], onDelete: Cascade)

  saleReturnId String     @unique
  saleReturn   SaleReturn @relation(fields: [saleReturnId], references: [id])

  reason                String
  amount                Float
  createdById           String
  createdBy             User                   @relation("CreditNotesCreatedBy", fields: [createdById], references: [id])
  createdAt             DateTime               @default(now())
  updatedAt             DateTime               @default(now())
  creditNoteAllocations CreditNoteAllocation[]
}

// ==================== SALE RETURNS ====================
model SaleReturn {
  id               String            @id @default(cuid())
  returnNumber     String            @unique
  saleId           String
  sale             Sale              @relation(fields: [saleId], references: [id], onDelete: Cascade)
  productId        String
  product          ProductList       @relation(fields: [productId], references: [id])
  quantity         Int
  reason           String
  createdById      String
  creditNote       CreditNote?
  createdBy        User              @relation("SaleReturnsCreatedBy", fields: [createdById], references: [id])
  locationId       String
  location         Location          @relation(fields: [locationId], references: [id])
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @default(now())
  inventoryHistory InventoryHistory?
  items            SaleReturnItem[]
}

model SaleReturnItem {
  id           String      @id @default(cuid())
  saleReturnId String
  saleReturn   SaleReturn  @relation(fields: [saleReturnId], references: [id], onDelete: Cascade)
  productId    String
  product      ProductList @relation(fields: [productId], references: [id])
  quantity     Int
  reason       String

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now())
}

model ProformaInvoice {
  id             String         @id @default(uuid())
  proformaNumber String         @unique
  salesOrderId   String
  customerId     String
  locationId     String
  status         ProformaStatus @default(DRAFT)
  createdById    String
  createdAt      DateTime       @default(now())

  salesOrder SalesOrder            @relation(fields: [salesOrderId], references: [id])
  customer   Customer              @relation(fields: [customerId], references: [id])
  location   Location              @relation(fields: [locationId], references: [id])
  items      ProformaInvoiceItem[]
}

model ProformaInvoiceItem {
  id         String @id @default(uuid())
  proformaId String
  productId  String
  quantity   Int
  price      Float
  total      Float

  proforma ProformaInvoice @relation(fields: [proformaId], references: [id])
  product  ProductList     @relation(fields: [productId], references: [id])
}

enum ProformaStatus {
  DRAFT
  SENT
  APPROVED
  CANCELLED
}

// ==================== TRANSFERS (IBT) ====================
model Transfer {
  id             String           @id @default(cuid())
  ibtNumber      String           @unique
  fromLocationId String
  fromLocation   Location         @relation("TransfersFrom", fields: [fromLocationId], references: [id])
  toLocationId   String
  toLocation     Location         @relation("TransfersTo", fields: [toLocationId], references: [id])
  transporterId  String?
  transporter    Transporter?     @relation(fields: [transporterId], references: [id])
  transferDate   DateTime         @default(now())
  createdById    String
  createdBy      User             @relation("TransfersCreatedBy", fields: [createdById], references: [id])
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @default(now())
  status         TransferStatus   @default(PENDING)
  items          TransferItem[]
  receipt        TransferReceipt?
}

model TransferItem {
  id         String      @id @default(cuid())
  transferId String
  transfer   Transfer    @relation(fields: [transferId], references: [id], onDelete: Cascade)
  productId  String
  product    ProductList @relation(fields: [productId], references: [id])
  quantity   Int
  updatedAt  DateTime    @default(now()) @updatedAt
}

model TransferReceipt {
  id           String                @id @default(cuid())
  transferId   String                @unique
  transfer     Transfer              @relation(fields: [transferId], references: [id], onDelete: Cascade)
  receivedById String
  receivedBy   User                  @relation("TransfersReceivedBy", fields: [receivedById], references: [id])
  receivedAt   DateTime              @default(now())
  items        TransferReceiptItem[]
}

model TransferReceiptItem {
  id                 String             @id @default(cuid())
  transferReceiptId  String
  transferReceipt    TransferReceipt    @relation(fields: [transferReceiptId], references: [id], onDelete: Cascade)
  productId          String
  product            ProductList        @relation(fields: [productId], references: [id])
  quantityReceived   Int
  quantityDamaged    Int
  quantityExpired    Int
  comment            String?
  updatedAt          DateTime           @default(now()) @updatedAt
  inventoryHistories InventoryHistory[]
}

// ==================== ENUMS ====================
enum TransferStatus {
  PENDING
  DISPATCHED
  RECEIVED
  CANCELLED
}

// ==================== PRODUCTION ====================
model Production {
  id           String             @id @default(cuid())
  productionNo String             @unique
  locationId   String
  location     Location           @relation(fields: [locationId], references: [id])
  batchNumber  String
  notes        String?
  status       ProductionStatus?  @default(DRAFT)
  createdById  String
  createdBy    User               @relation("ProductionsCreatedBy", fields: [createdById], references: [id])
  createdAt    DateTime           @default(now())
  updatedAt    DateTime           @default(now())
  items        ProductionItem[]
  defects      ProductionDefect[]

  @@index([createdAt])
  @@index([locationId])
  @@index([batchNumber])
}

model ProductionItem {
  id                 String             @id @default(cuid())
  productionId       String
  production         Production         @relation(fields: [productionId], references: [id], onDelete: Cascade)
  productId          String
  product            ProductList        @relation(fields: [productId], references: [id])
  quantity           Int
  updatedAt          DateTime           @default(now()) @updatedAt
  inventoryHistories InventoryHistory[]
}

model ProductionDefect {
  id           String     @id @default(cuid())
  productionId String
  production   Production @relation(fields: [productionId], references: [id], onDelete: Cascade)

  productId String
  product   ProductList @relation(fields: [productId], references: [id])

  quantity   Int
  defectType DefectType
  reason     String?

  disposition DefectDisposition @default(SCRAPPED)

  recordedById String
  recordedBy   User   @relation(fields: [recordedById], references: [id])

  createdAt          DateTime           @default(now())
  updatedAt          DateTime           @updatedAt
  inventoryHistories InventoryHistory[]

  @@index([productionId])
  @@index([productId])
}

enum DefectType {
  PACKAGING
  CONTAMINATION
  WEIGHT_VARIANCE
  DAMAGED
  EXPIRED
  OTHER
}

enum DefectDisposition {
  SCRAPPED // destroyed / written off
  REWORKED // sent back to production
  RETURNED // returned to supplier
  HELD // pending decision
}

// ==================== ADJUSTMENTS ====================
model Adjustment {
  id           String           @id @default(cuid())
  adjustmentNo String           @unique
  locationId   String
  location     Location         @relation(fields: [locationId], references: [id])
  type         AdjustmentType
  reason       String?
  createdById  String
  createdBy    User             @relation("AdjustmentsCreatedBy", fields: [createdById], references: [id])
  createdAt    DateTime         @default(now())
  updatedAt    DateTime         @default(now())
  items        AdjustmentItem[]
}

model AdjustmentItem {
  id                 String             @id @default(cuid())
  adjustmentId       String
  adjustment         Adjustment         @relation(fields: [adjustmentId], references: [id], onDelete: Cascade)
  productId          String
  product            ProductList        @relation(fields: [productId], references: [id])
  quantity           Int
  updatedAt          DateTime           @default(now()) @updatedAt
  inventoryHistories InventoryHistory[]
}

enum AdjustmentType {
  DAMAGED
  EXPIRED
  MANUAL
}

model AccountingPeriod {
  id       String    @id @default(cuid())
  year     Int
  month    Int
  isClosed Boolean   @default(false)
  closedAt DateTime?
  closedBy String?

  @@unique([year, month])
}

model CustomerStatement {
  id          String @id @default(cuid())
  customerId  String
  periodYear  Int
  periodMonth Int

  openingBalance Decimal
  closingBalance Decimal

  issuedAt   DateTime @default(now())
  issuedById String
  issuedBy   User     @relation(fields: [issuedById], references: [id])

  locked Boolean @default(true)

  lines CustomerStatementLine[]

  @@unique([customerId, periodYear, periodMonth])
}

model CustomerStatementLine {
  id          String            @id @default(cuid())
  statementId String
  statement   CustomerStatement @relation(fields: [statementId], references: [id], onDelete: Cascade)

  date      DateTime
  reference String
  type      String

  debit   Decimal
  credit  Decimal
  balance Decimal
}

// ==================== ENUMS ====================
enum SalesOrderStatus {
  PENDING
  CONFIRMED
  PARTIALLY_INVOICED
  CANCELLED
}

enum SaleStatus {
  PENDING
  CONFIRMED
  PARTIALLY_INVOICED
  PARTIALLY_PAID
  PAID
  CANCELLED
}

enum ProductionStatus {
  DRAFT
  CONFIRMED
  LOCKED
}

// ==================== BILL OF MATERIALS ====================
model BOM {
  id          String      @id @default(cuid())
  productId   String // the finished product
  product     ProductList @relation(fields: [productId], references: [id])
  version     Int         @default(1)
  description String?
  status      BOMStatus   @default(ACTIVE)
  createdById String
  createdBy   User        @relation(fields: [createdById], references: [id])
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  components BOMItem[]

  @@unique([productId, version])
  @@index([productId])
}

model BOMItem {
  id          String      @id @default(cuid())
  bomId       String
  bom         BOM         @relation(fields: [bomId], references: [id], onDelete: Cascade)
  component   ProductList @relation(fields: [componentId], references: [id])
  componentId String
  quantity    Float // quantity required for the finished product
  unit        String // unit of measurement, e.g., kg, pcs
  notes       String?
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @default(now())

  @@index([bomId])
  @@index([componentId])
}

enum BOMStatus {
  DRAFT
  ACTIVE
  INACTIVE
  ARCHIVED
}

// ==================== SUPPLIERS ====================
model Supplier {
  id         String   @id @default(cuid())
  name       String
  email      String?  @unique
  phone      String?
  address    String?
  tpinNumber String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @default(now())

  purchaseOrders PurchaseOrder[]
  supplierPrices SupplierPrice[]
}

// Supplier price per product
model SupplierPrice {
  id         String      @id @default(cuid())
  supplierId String
  supplier   Supplier    @relation(fields: [supplierId], references: [id])
  productId  String
  product    ProductList @relation(fields: [productId], references: [id])
  price      Float
  uom        String?

  @@unique([supplierId, productId])
}

// ==================== PURCHASE ORDERS ====================
enum PurchaseOrderStatus {
  DRAFT
  SUBMITTED
  APPROVED
  SENT
  PARTIALLY_RECEIVED
  RECEIVED
  CANCELLED
}

model PurchaseOrder {
  id          String              @id @default(cuid())
  poNumber    String              @unique
  supplierId  String
  supplier    Supplier            @relation(fields: [supplierId], references: [id])
  locationId  String
  location    Location            @relation(fields: [locationId], references: [id])
  status      PurchaseOrderStatus @default(DRAFT)
  notes       String?
  createdById String
  createdBy   User                @relation(fields: [createdById], references: [id])
  createdAt   DateTime            @default(now())
  updatedAt   DateTime            @default(now()) @updatedAt

  items PurchaseOrderItem[]
  grns  GRN[]
}

model PurchaseOrderItem {
  id               String        @id @default(cuid())
  purchaseOrderId  String
  purchaseOrder    PurchaseOrder @relation(fields: [purchaseOrderId], references: [id], onDelete: Cascade)
  productId        String
  product          ProductList   @relation(fields: [productId], references: [id])
  quantity         Int
  receivedQuantity Int           @default(0)
  returnedQuantity Int           @default(0)
  uom              String
  unitPrice        Float
  plannedDate      DateTime?
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @default(now()) @updatedAt
  grnitems         GRNItem[]

  @@index([purchaseOrderId])
  @@index([productId])
}

model GRN {
  id         String    @id @default(cuid())
  grnNumber  String    @unique
  poId       String
  locationId String
  status     GRNStatus @default(DRAFT)
  locked     Boolean   @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  po              PurchaseOrder    @relation(fields: [poId], references: [id])
  items           GRNItem[]
  location        Location         @relation(fields: [locationId], references: [id])
  supplierReturns SupplierReturn[]
}

model GRNItem {
  id               String @id @default(cuid())
  grnId            String
  poItemId         String
  quantityExpected Float?
  quantityReceived Float
  returnedQuantity Float  @default(0)

  grn                 GRN                  @relation(fields: [grnId], references: [id])
  poItem              PurchaseOrderItem    @relation(fields: [poItemId], references: [id])
  supplierReturnItems SupplierReturnItem[]
  inventoryHistories  InventoryHistory[]
}

enum GRNStatus {
  DRAFT
  PARTIALLY_RECEIVED
  RECEIVED
  CLOSED
}

model SupplierReturn {
  id          String   @id @default(cuid())
  returnNo    String   @unique
  grnId       String
  grn         GRN      @relation(fields: [grnId], references: [id])
  reason      String?
  createdById String
  createdAt   DateTime @default(now())

  items SupplierReturnItem[]
}

model SupplierReturnItem {
  id               String         @id @default(cuid())
  supplierReturnId String
  supplierReturn   SupplierReturn @relation(fields: [supplierReturnId], references: [id])

  grnItemId String
  grnItem   GRNItem @relation(fields: [grnItemId], references: [id])

  quantity Float
}

// ==================== SALES TARGETS ====================

model SalesTargetBatch {
  id String @id @default(cuid())

  name String? // e.g., "January 2026 Targets"

  year  Int
  month Int? // null = yearly target

  locationId String?
  location   Location? @relation(fields: [locationId], references: [id])

  status SalesTargetStatus @default(DRAFT)

  locked     Boolean   @default(false)
  lockedAt   DateTime?
  lockedById String?
  lockedBy   User? @relation("SalesTargetBatchLockedBy", fields: [lockedById], references: [id])

  createdById String
  createdBy   User @relation("SalesTargetBatchCreatedBy", fields: [createdById], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  lines  SalesTargetLine[]
  audits SalesTargetBatchAudit[]

  @@index([year, month])
  @@index([locationId])
}

model SalesTargetLine {
  id String @id @default(cuid())

  batchId String
  batch   SalesTargetBatch @relation(fields: [batchId], references: [id], onDelete: Cascade)

  targetAmount   Decimal
  achievedAmount Decimal @default(0)

  // Dimensions
  userId     String?
  user       User? @relation(fields: [userId], references: [id])

  productId  String?
  product    ProductList? @relation(fields: [productId], references: [id])

  locationId String?
  location   Location? @relation(fields: [locationId], references: [id])

  notes String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  audits SalesTargetLineAudit[]

  @@index([batchId])
  @@index([userId])
  @@index([productId])
  @@index([locationId])
}

model SalesTargetBatchAudit {
  id String @id @default(cuid())

  batchId String
  batch   SalesTargetBatch @relation(fields: [batchId], references: [id])

  action SalesTargetAction
  performedById String
  performedBy   User @relation(fields: [performedById], references: [id])

  reason String?
  createdAt DateTime @default(now())

  @@index([batchId])
}

model SalesTargetLineAudit {
  id String @id @default(cuid())

  lineId String
  line   SalesTargetLine @relation(fields: [lineId], references: [id])

  fieldChanged String? // e.g., targetAmount, achievedAmount
  oldValue Decimal?
  newValue Decimal?

  action SalesTargetAction

  performedById String
  performedBy   User @relation(fields: [performedById], references: [id])

  reason String?
  createdAt DateTime @default(now())

  @@index([lineId])
}

// ==================== ENUMS ====================

enum SalesTargetStatus {
  DRAFT
  APPROVED
  LOCKED
}

enum SalesTargetAction {
  CREATE
  UPDATE
  IMPORT
  APPROVE
  LOCK
  DELETE
}
