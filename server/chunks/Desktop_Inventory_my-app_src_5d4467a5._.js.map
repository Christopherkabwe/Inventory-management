{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 6, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/CHRISTOPHER%20KABWE/Desktop/Inventory/my-app/src/lib/prisma.ts"],"sourcesContent":["import \"dotenv/config\";\nimport { PrismaPg } from '@prisma/adapter-pg'\nimport { PrismaClient } from '../generated/prisma/client'\n\nconst connectionString = `${process.env.DATABASE_URL}`\n\nconst adapter = new PrismaPg({ connectionString })\nconst prisma = new PrismaClient({ adapter })\n\nexport { prisma };"],"names":[],"mappings":";;;;AAAA;AACA;AACA;;;;;;;;AAEA,MAAM,mBAAmB,GAAG,QAAQ,GAAG,CAAC,YAAY,EAAE;AAEtD,MAAM,UAAU,IAAI,8MAAQ,CAAC;IAAE;AAAiB;AAChD,MAAM,SAAS,IAAI,2LAAY,CAAC;IAAE;AAAQ"}},
    {"offset": {"line": 35, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/CHRISTOPHER%20KABWE/Desktop/Inventory/my-app/src/app/api/sales/route.js"],"sourcesContent":["import { NextResponse } from \"next/server\";\r\nimport { prisma } from \"@/lib/prisma\";\r\n\r\nexport async function GET(request) {\r\n    const { searchParams } = new URL(request.url);\r\n\r\n    const userId = searchParams.get(\"userId\");\r\n    const page = Number(searchParams.get(\"page\") || 1);\r\n    const limitParam = searchParams.get(\"limit\");\r\n\r\n    if (!userId) {\r\n        return NextResponse.json({ error: \"userId is required\" }, { status: 400 });\r\n    }\r\n\r\n    const limit = limitParam ? Number(limitParam) : null;\r\n    const skip = limit ? (page - 1) * limit : undefined;\r\n\r\n    try {\r\n        const [sales, totalSales] = await Promise.all([\r\n            prisma.sale.findMany({\r\n                where: {\r\n                    createdBy: userId\r\n                },\r\n                include: {\r\n                    product: {\r\n                        select: {\r\n                            name: true,\r\n                            id: true,\r\n                            price: true,\r\n                            category: true,\r\n                            packSize: true,\r\n                            weightValue: true,\r\n                            weightUnit: true,\r\n                        }\r\n                    },\r\n                    customer: {\r\n                        select: {\r\n                            name: true,\r\n                            email: true\r\n                        }\r\n                    },\r\n                    location: {\r\n                        select: {\r\n                            id: true,\r\n                            name: true\r\n                        }\r\n                    },\r\n                },\r\n                orderBy: {\r\n                    createdAt: \"desc\"\r\n                },\r\n                ...(limit && { skip, take: limit }),\r\n            }),\r\n            prisma.sale.count({ where: { createdBy: userId } }),\r\n        ]);\r\n\r\n        // ðŸŸ¢ Paginated response\r\n        if (limit) {\r\n            return NextResponse.json({\r\n                success: true,\r\n                data: sales,\r\n                pagination: {\r\n                    page,\r\n                    limit,\r\n                    totalSales,\r\n                    totalPages: Math.ceil(totalSales / limit),\r\n                },\r\n            });\r\n        }\r\n\r\n        // ðŸŸ¢ Unpaginated response (dashboard)\r\n        return NextResponse.json({\r\n            success: true,\r\n            data: sales,\r\n            totalSales,\r\n        });\r\n\r\n    } catch (error) {\r\n        console.error(error);\r\n        return NextResponse.json(\r\n            { error: \"Failed to fetch sales\" },\r\n            { status: 500 }\r\n        );\r\n    }\r\n}\r\n\r\n\r\nexport async function POST(request) {\r\n    try {\r\n        const { productId, quantity, customerId, salePrice, userId, locationId } = await request.json();\r\n\r\n        if (!productId || quantity <= 0 || !customerId || !userId || salePrice <= 0 || !locationId) {\r\n            return NextResponse.json(\r\n                { error: \"Missing or invalid fields: product, quantity, customer, user, location or price.\" },\r\n                { status: 400 }\r\n            );\r\n        }\r\n\r\n        const customer = await prisma.customer.findUnique({ where: { id: customerId } });\r\n        if (!customer) {\r\n            return NextResponse.json({ error: \"Customer not found\" }, { status: 404 });\r\n        }\r\n\r\n        const product = await prisma.productList.findUnique({ where: { id: productId } });\r\n        if (!product) {\r\n            return NextResponse.json({ error: \"Product not found\" }, { status: 404 });\r\n        }\r\n\r\n        const inventory = await prisma.inventory.findUnique({\r\n            where: { productId_locationId: { productId, locationId } },\r\n        });\r\n        if (!inventory || inventory.quantity < quantity) {\r\n            return NextResponse.json(\r\n                { error: `Insufficient stock for \"${product.name}\" at this location. Available: ${inventory?.quantity || 0}.` },\r\n                { status: 400 }\r\n            );\r\n        }\r\n\r\n        const totalAmount = salePrice * quantity;\r\n        const customerName = customer.name;\r\n\r\n        const sale = await prisma.$transaction(async (tx) => {\r\n            await tx.inventory.update({\r\n                where: { id: inventory.id },\r\n                data: { quantity: { decrement: quantity } },\r\n            });\r\n            const newSale = await tx.sale.create({\r\n                data: {\r\n                    customerId,\r\n                    customerName,\r\n                    productId,\r\n                    productName: product.name,\r\n                    locationId, // Use locationId\r\n                    quantity,\r\n                    salePrice,\r\n                    totalAmount,\r\n                    createdBy: userId,\r\n                },\r\n            });\r\n            return newSale;\r\n        });\r\n\r\n        return NextResponse.json(sale, { status: 201 });\r\n    } catch (error) {\r\n        console.error(error);\r\n        return NextResponse.json(\r\n            { success: false, message: \"Failed to create sale\" },\r\n            { status: 500 }\r\n        );\r\n    }\r\n}\r\n"],"names":[],"mappings":"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"}}]
}