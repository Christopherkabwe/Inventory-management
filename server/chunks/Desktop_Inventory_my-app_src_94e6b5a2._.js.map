{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 6, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/CHRISTOPHER%20KABWE/Desktop/Inventory/my-app/src/lib/prisma.ts"],"sourcesContent":["import \"dotenv/config\";\nimport { PrismaPg } from '@prisma/adapter-pg'\nimport { PrismaClient } from '../generated/prisma/client'\n\nconst connectionString = `${process.env.DATABASE_URL}`\n\nconst adapter = new PrismaPg({ connectionString })\nconst prisma = new PrismaClient({ adapter })\n\nexport { prisma };"],"names":[],"mappings":";;;;AAAA;AACA;AACA;;;;;;;;AAEA,MAAM,mBAAmB,GAAG,QAAQ,GAAG,CAAC,YAAY,EAAE;AAEtD,MAAM,UAAU,IAAI,8MAAQ,CAAC;IAAE;AAAiB;AAChD,MAAM,SAAS,IAAI,2LAAY,CAAC;IAAE;AAAQ"}},
    {"offset": {"line": 35, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/CHRISTOPHER%20KABWE/Desktop/Inventory/my-app/src/app/api/stock-report/route.ts"],"sourcesContent":["import { prisma } from '@/lib/prisma';\r\nimport { NextResponse } from 'next/server';\r\n\r\nexport async function GET(req: Request) {\r\n    try {\r\n        const url = new URL(req.url);\r\n        const startDateParam = url.searchParams.get('startDate'); // e.g., \"2025-12-24\"\r\n        const endDateParam = url.searchParams.get('endDate');     // e.g., \"2025-12-25\"\r\n\r\n        const startDate = startDateParam ? new Date(startDateParam) : null;\r\n        const endDate = endDateParam ? new Date(endDateParam) : null;\r\n\r\n        // 1️⃣ Get all movements, ordered chronologically\r\n        const movements = await prisma.stockMovement.findMany({\r\n            include: {\r\n                inventory: {\r\n                    include: { product: true, location: true },\r\n                },\r\n            },\r\n            orderBy: { createdAt: 'asc' },\r\n        });\r\n\r\n        const reportMap = new Map<string, any>();\r\n\r\n        movements.forEach(mv => {\r\n            const key = `${mv.inventory.product.name}-${mv.inventory.location.name}`;\r\n\r\n            if (!reportMap.has(key)) {\r\n                reportMap.set(key, {\r\n                    productName: mv.inventory.product.name,\r\n                    locationName: mv.inventory.location.name,\r\n                    openingStock: 0,\r\n                    receipts: 0,\r\n                    sales: 0,\r\n                    transfersIn: 0,\r\n                    transfersOut: 0,\r\n                    returns: 0,\r\n                    damaged: 0,\r\n                    expired: 0,\r\n                    rebagGain: 0,\r\n                    rebagLoss: 0,\r\n                    closingStock: mv.openingStock ?? 0,\r\n                });\r\n            }\r\n\r\n            const item = reportMap.get(key);\r\n\r\n            // --- 2️⃣ Calculate opening stock ---\r\n            // Movements before startDate affect opening stock\r\n            if (startDate && mv.createdAt < startDate) {\r\n                switch (mv.type) {\r\n                    case 'RECEIPT': item.closingStock += mv.quantity; break;\r\n                    case 'SALE': item.closingStock -= mv.quantity; break;\r\n                    case 'TRANSFER_IN': item.closingStock += mv.quantity; break;\r\n                    case 'TRANSFER_OUT': item.closingStock -= mv.quantity; break;\r\n                    case 'RETURN': item.closingStock += mv.quantity; break;\r\n                    case 'DAMAGED': break; // info only\r\n                    case 'EXPIRED': break;\r\n                    case 'REBAG_GAIN': item.closingStock += mv.quantity; break;\r\n                    case 'REBAG_LOSS': item.closingStock -= mv.quantity; break;\r\n                }\r\n                item.openingStock = item.closingStock;\r\n                return; // skip adding to period totals\r\n            }\r\n\r\n            // --- 3️⃣ Aggregate movements within range ---\r\n            if ((!startDate || mv.createdAt >= startDate) && (!endDate || mv.createdAt <= endDate)) {\r\n                switch (mv.type) {\r\n                    case 'RECEIPT': item.receipts += mv.quantity; item.closingStock += mv.quantity; break;\r\n                    case 'SALE': item.sales += mv.quantity; item.closingStock -= mv.quantity; break;\r\n                    case 'TRANSFER_IN': item.transfersIn += mv.quantity; item.closingStock += mv.quantity; break;\r\n                    case 'TRANSFER_OUT': item.transfersOut += mv.quantity; item.closingStock -= mv.quantity; break;\r\n                    case 'RETURN': item.returns += mv.quantity; item.closingStock += mv.quantity; break;\r\n                    case 'DAMAGED': item.damaged += mv.quantity; break;\r\n                    case 'EXPIRED': item.expired += mv.quantity; break;\r\n                    case 'REBAG_GAIN': item.rebagGain += mv.quantity; item.closingStock += mv.quantity; break;\r\n                    case 'REBAG_LOSS': item.rebagLoss += mv.quantity; item.closingStock -= mv.quantity; break;\r\n                }\r\n            }\r\n\r\n            // --- 4️⃣ Movements after endDate do not affect period totals, but do affect future closing stock ---\r\n            if (endDate && mv.createdAt > endDate) {\r\n                switch (mv.type) {\r\n                    case 'RECEIPT': item.closingStock += mv.quantity; break;\r\n                    case 'SALE': item.closingStock -= mv.quantity; break;\r\n                    case 'TRANSFER_IN': item.closingStock += mv.quantity; break;\r\n                    case 'TRANSFER_OUT': item.closingStock -= mv.quantity; break;\r\n                    case 'RETURN': item.closingStock += mv.quantity; break;\r\n                    case 'DAMAGED': break;\r\n                    case 'EXPIRED': break;\r\n                    case 'REBAG_GAIN': item.closingStock += mv.quantity; break;\r\n                    case 'REBAG_LOSS': item.closingStock -= mv.quantity; break;\r\n                }\r\n            }\r\n        });\r\n\r\n        return NextResponse.json(Array.from(reportMap.values()));\r\n    } catch (err) {\r\n        console.error(err);\r\n        return NextResponse.json({ error: 'Failed to generate stock report' }, { status: 500 });\r\n    }\r\n}\r\n"],"names":[],"mappings":"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"}}]
}