{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 6, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/CHRISTOPHER%20KABWE/Desktop/Inventory/my-app/src/lib/prisma.ts"],"sourcesContent":["import \"dotenv/config\";\nimport { PrismaPg } from '@prisma/adapter-pg'\nimport { PrismaClient } from '../generated/prisma/client'\n\nconst connectionString = `${process.env.DATABASE_URL}`\n\nconst adapter = new PrismaPg({ connectionString })\nconst prisma = new PrismaClient({ adapter })\n\nexport { prisma };"],"names":[],"mappings":";;;;AAAA;AACA;AACA;;;;;;;;AAEA,MAAM,mBAAmB,GAAG,QAAQ,GAAG,CAAC,YAAY,EAAE;AAEtD,MAAM,UAAU,IAAI,yKAAQ,CAAC;IAAE;AAAiB;AAChD,MAAM,SAAS,IAAI,sJAAY,CAAC;IAAE;AAAQ"}},
    {"offset": {"line": 35, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/CHRISTOPHER%20KABWE/Desktop/Inventory/my-app/src/app/api/sales/route.js"],"sourcesContent":["import { NextResponse } from \"next/server\";\r\nimport { prisma } from \"@/lib/prisma\";\r\n\r\nexport async function GET(request) {\r\n    try {\r\n        const { searchParams } = new URL(request.url);\r\n        const userId = searchParams.get(\"userId\");\r\n        const page = Number(searchParams.get(\"page\") || 1);\r\n        const limitParam = searchParams.get(\"limit\");\r\n        const limit = limitParam ? Number(limitParam) : null;\r\n        const skip = limit && (page - 1) * limit;\r\n\r\n        if (!userId) {\r\n            return NextResponse.json({ error: \"userId is required\" }, { status: 400 });\r\n        }\r\n\r\n        // Fetch sales with relations\r\n        const [sales, totalSales] = await Promise.all([\r\n            prisma.sale.findMany({\r\n                where: { createdBy: userId },\r\n                include: {\r\n                    customer: {\r\n                        select: {\r\n                            id: true,\r\n                            name: true,\r\n                            email: true,\r\n                            phone: true,\r\n                            country: true,\r\n                            city: true,\r\n                            createdBy: true,\r\n                            createdAt: true,\r\n                            updatedAt: true,\r\n                        },\r\n                    },\r\n                    product: {\r\n                        select: {\r\n                            id: true,\r\n                            sku: true,\r\n                            name: true,\r\n                            price: true,\r\n                            packSize: true,\r\n                            category: true,\r\n                            weightValue: true,\r\n                            weightUnit: true,\r\n                            createdBy: true,\r\n                            createdAt: true,\r\n                            updatedAt: true,\r\n                        },\r\n                    },\r\n                    location: {\r\n                        select: {\r\n                            id: true,\r\n                            name: true,\r\n                            address: true,\r\n                            createdBy: true,\r\n                            createdAt: true,\r\n                            updatedAt: true,\r\n                        },\r\n                    },\r\n                },\r\n                orderBy: { createdAt: \"desc\" },\r\n                ...(limit && { skip, take: limit }),\r\n            }),\r\n            prisma.sale.count({ where: { createdBy: userId } }),\r\n        ]);\r\n\r\n        // Return paginated or unpaginated response\r\n        if (limit) {\r\n            return NextResponse.json({\r\n                success: true,\r\n                data: sales,\r\n                pagination: {\r\n                    page,\r\n                    limit,\r\n                    totalSales,\r\n                    totalPages: Math.ceil(totalSales / limit),\r\n                },\r\n            });\r\n        }\r\n\r\n        return NextResponse.json({\r\n            success: true,\r\n            data: sales,\r\n            totalSales,\r\n        });\r\n    } catch (error) {\r\n        console.error(error);\r\n        return NextResponse.json({ error: \"Failed to fetch sales\" }, { status: 500 });\r\n    }\r\n}\r\n\r\nexport async function POST(request) {\r\n    try {\r\n        const { productId, quantity, customerId, salePrice, userId, locationId } = await request.json();\r\n\r\n        if (!productId || quantity <= 0 || !customerId || !userId || salePrice <= 0 || !locationId) {\r\n            return NextResponse.json(\r\n                { error: \"Missing or invalid fields: product, quantity, customer, user, location or price.\" },\r\n                { status: 400 }\r\n            );\r\n        }\r\n\r\n        // Check related records exist\r\n        const [customer, product, inventory] = await Promise.all([\r\n            prisma.customer.findUnique({ where: { id: customerId } }),\r\n            prisma.productList.findUnique({ where: { id: productId } }),\r\n            prisma.inventory.findUnique({ where: { productId_locationId: { productId, locationId } } }),\r\n        ]);\r\n\r\n        if (!customer) return NextResponse.json({ error: \"Customer not found\" }, { status: 404 });\r\n        if (!product) return NextResponse.json({ error: \"Product not found\" }, { status: 404 });\r\n        if (!inventory || inventory.quantity < quantity) {\r\n            return NextResponse.json(\r\n                { error: `Insufficient stock for \"${product.name}\" at this location. Available: ${inventory?.quantity || 0}.` },\r\n                { status: 400 }\r\n            );\r\n        }\r\n\r\n        const totalAmount = salePrice * quantity;\r\n        const sale = await prisma.$transaction(async (tx) => {\r\n            await tx.inventory.update({\r\n                where: { id: inventory.id },\r\n                data: { quantity: { decrement: quantity } },\r\n            });\r\n\r\n            const newSale = await tx.sale.create({\r\n                data: {\r\n                    customerId,\r\n                    customerName: customer.name, // add customerName\r\n                    productId,\r\n                    locationId,\r\n                    quantity,\r\n                    salePrice,\r\n                    totalAmount,\r\n                    createdBy: userId,\r\n                },\r\n                include: {\r\n                    customer: {\r\n                        select: {\r\n                            id: true,\r\n                            name: true,\r\n                            email: true,\r\n                            phone: true,\r\n                            country: true,\r\n                            city: true,\r\n                            createdBy: true,\r\n                            createdAt: true,\r\n                            updatedAt: true,\r\n                        },\r\n                    },\r\n                    product: {\r\n                        select: {\r\n                            id: true,\r\n                            sku: true,\r\n                            name: true,\r\n                            price: true,\r\n                            packSize: true,\r\n                            category: true,\r\n                            weightValue: true,\r\n                            weightUnit: true,\r\n                            createdBy: true,\r\n                            createdAt: true,\r\n                            updatedAt: true,\r\n                        },\r\n                    },\r\n                    location: {\r\n                        select: {\r\n                            id: true,\r\n                            name: true,\r\n                            address: true,\r\n                            createdBy: true,\r\n                            createdAt: true,\r\n                            updatedAt: true,\r\n                        },\r\n                    },\r\n                },\r\n            });\r\n\r\n            return newSale;\r\n        });\r\n\r\n        return NextResponse.json(sale, { status: 201 });\r\n    } catch (error) {\r\n        console.error(error);\r\n        return NextResponse.json({ success: false, message: \"Failed to create sale\" }, { status: 500 });\r\n    }\r\n}\r\n\r\n"],"names":[],"mappings":";;;;;;AAAA;AACA;;;;;;;AAEO,eAAe,IAAI,OAAO;IAC7B,IAAI;QACA,MAAM,EAAE,YAAY,EAAE,GAAG,IAAI,IAAI,QAAQ,GAAG;QAC5C,MAAM,SAAS,aAAa,GAAG,CAAC;QAChC,MAAM,OAAO,OAAO,aAAa,GAAG,CAAC,WAAW;QAChD,MAAM,aAAa,aAAa,GAAG,CAAC;QACpC,MAAM,QAAQ,aAAa,OAAO,cAAc;QAChD,MAAM,OAAO,SAAS,CAAC,OAAO,CAAC,IAAI;QAEnC,IAAI,CAAC,QAAQ;YACT,OAAO,gJAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;YAAqB,GAAG;gBAAE,QAAQ;YAAI;QAC5E;QAEA,6BAA6B;QAC7B,MAAM,CAAC,OAAO,WAAW,GAAG,MAAM,QAAQ,GAAG,CAAC;YAC1C,gIAAM,CAAC,IAAI,CAAC,QAAQ,CAAC;gBACjB,OAAO;oBAAE,WAAW;gBAAO;gBAC3B,SAAS;oBACL,UAAU;wBACN,QAAQ;4BACJ,IAAI;4BACJ,MAAM;4BACN,OAAO;4BACP,OAAO;4BACP,SAAS;4BACT,MAAM;4BACN,WAAW;4BACX,WAAW;4BACX,WAAW;wBACf;oBACJ;oBACA,SAAS;wBACL,QAAQ;4BACJ,IAAI;4BACJ,KAAK;4BACL,MAAM;4BACN,OAAO;4BACP,UAAU;4BACV,UAAU;4BACV,aAAa;4BACb,YAAY;4BACZ,WAAW;4BACX,WAAW;4BACX,WAAW;wBACf;oBACJ;oBACA,UAAU;wBACN,QAAQ;4BACJ,IAAI;4BACJ,MAAM;4BACN,SAAS;4BACT,WAAW;4BACX,WAAW;4BACX,WAAW;wBACf;oBACJ;gBACJ;gBACA,SAAS;oBAAE,WAAW;gBAAO;gBAC7B,GAAI,SAAS;oBAAE;oBAAM,MAAM;gBAAM,CAAC;YACtC;YACA,gIAAM,CAAC,IAAI,CAAC,KAAK,CAAC;gBAAE,OAAO;oBAAE,WAAW;gBAAO;YAAE;SACpD;QAED,2CAA2C;QAC3C,IAAI,OAAO;YACP,OAAO,gJAAY,CAAC,IAAI,CAAC;gBACrB,SAAS;gBACT,MAAM;gBACN,YAAY;oBACR;oBACA;oBACA;oBACA,YAAY,KAAK,IAAI,CAAC,aAAa;gBACvC;YACJ;QACJ;QAEA,OAAO,gJAAY,CAAC,IAAI,CAAC;YACrB,SAAS;YACT,MAAM;YACN;QACJ;IACJ,EAAE,OAAO,OAAO;QACZ,QAAQ,KAAK,CAAC;QACd,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,OAAO;QAAwB,GAAG;YAAE,QAAQ;QAAI;IAC/E;AACJ;AAEO,eAAe,KAAK,OAAO;IAC9B,IAAI;QACA,MAAM,EAAE,SAAS,EAAE,QAAQ,EAAE,UAAU,EAAE,SAAS,EAAE,MAAM,EAAE,UAAU,EAAE,GAAG,MAAM,QAAQ,IAAI;QAE7F,IAAI,CAAC,aAAa,YAAY,KAAK,CAAC,cAAc,CAAC,UAAU,aAAa,KAAK,CAAC,YAAY;YACxF,OAAO,gJAAY,CAAC,IAAI,CACpB;gBAAE,OAAO;YAAmF,GAC5F;gBAAE,QAAQ;YAAI;QAEtB;QAEA,8BAA8B;QAC9B,MAAM,CAAC,UAAU,SAAS,UAAU,GAAG,MAAM,QAAQ,GAAG,CAAC;YACrD,gIAAM,CAAC,QAAQ,CAAC,UAAU,CAAC;gBAAE,OAAO;oBAAE,IAAI;gBAAW;YAAE;YACvD,gIAAM,CAAC,WAAW,CAAC,UAAU,CAAC;gBAAE,OAAO;oBAAE,IAAI;gBAAU;YAAE;YACzD,gIAAM,CAAC,SAAS,CAAC,UAAU,CAAC;gBAAE,OAAO;oBAAE,sBAAsB;wBAAE;wBAAW;oBAAW;gBAAE;YAAE;SAC5F;QAED,IAAI,CAAC,UAAU,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,OAAO;QAAqB,GAAG;YAAE,QAAQ;QAAI;QACvF,IAAI,CAAC,SAAS,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,OAAO;QAAoB,GAAG;YAAE,QAAQ;QAAI;QACrF,IAAI,CAAC,aAAa,UAAU,QAAQ,GAAG,UAAU;YAC7C,OAAO,gJAAY,CAAC,IAAI,CACpB;gBAAE,OAAO,CAAC,wBAAwB,EAAE,QAAQ,IAAI,CAAC,+BAA+B,EAAE,WAAW,YAAY,EAAE,CAAC,CAAC;YAAC,GAC9G;gBAAE,QAAQ;YAAI;QAEtB;QAEA,MAAM,cAAc,YAAY;QAChC,MAAM,OAAO,MAAM,gIAAM,CAAC,YAAY,CAAC,OAAO;YAC1C,MAAM,GAAG,SAAS,CAAC,MAAM,CAAC;gBACtB,OAAO;oBAAE,IAAI,UAAU,EAAE;gBAAC;gBAC1B,MAAM;oBAAE,UAAU;wBAAE,WAAW;oBAAS;gBAAE;YAC9C;YAEA,MAAM,UAAU,MAAM,GAAG,IAAI,CAAC,MAAM,CAAC;gBACjC,MAAM;oBACF;oBACA,cAAc,SAAS,IAAI;oBAC3B;oBACA;oBACA;oBACA;oBACA;oBACA,WAAW;gBACf;gBACA,SAAS;oBACL,UAAU;wBACN,QAAQ;4BACJ,IAAI;4BACJ,MAAM;4BACN,OAAO;4BACP,OAAO;4BACP,SAAS;4BACT,MAAM;4BACN,WAAW;4BACX,WAAW;4BACX,WAAW;wBACf;oBACJ;oBACA,SAAS;wBACL,QAAQ;4BACJ,IAAI;4BACJ,KAAK;4BACL,MAAM;4BACN,OAAO;4BACP,UAAU;4BACV,UAAU;4BACV,aAAa;4BACb,YAAY;4BACZ,WAAW;4BACX,WAAW;4BACX,WAAW;wBACf;oBACJ;oBACA,UAAU;wBACN,QAAQ;4BACJ,IAAI;4BACJ,MAAM;4BACN,SAAS;4BACT,WAAW;4BACX,WAAW;4BACX,WAAW;wBACf;oBACJ;gBACJ;YACJ;YAEA,OAAO;QACX;QAEA,OAAO,gJAAY,CAAC,IAAI,CAAC,MAAM;YAAE,QAAQ;QAAI;IACjD,EAAE,OAAO,OAAO;QACZ,QAAQ,KAAK,CAAC;QACd,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,SAAS;YAAO,SAAS;QAAwB,GAAG;YAAE,QAAQ;QAAI;IACjG;AACJ"}}]
}